<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="3.css" />
</head>

<body>

    <div class="box">
        <div id="print" style="width:980px;height: 40px;position: fixed;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ú–æ—Ä—Å–∫–æ–π –±–æ–π - –∏–≥—Ä—ã –Ω–∞ –¥–≤–æ–∏—Ö !</div>
        <div id="first_field" class="field"></div>
        <div style="width: 100px;height:100px;">
            <input type="button" id="change" value="üóò" style="width: 40px;height:30px;margin-top:80%;display:none;" onclick="changeField();" />
        </div>
        <div id="second_field" class="field"></div>

        <form name="search" id="searchf" style="

    position: fixed;
    top: 90%;
   width:980px;
   height:100px;
    text-align: center;">
            <input type="button" name="start" value="–í–ø–µ—Ä–µ–¥" style="width: 90px;" onclick="chooseField();" />
            <input type="button" name="success" value="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" style="width: 90px;display: none;" onclick="emptyField();" />
            <input type="button" name="ready" value="–ù–∞—á–∞—Ç—å –∏–≥—Ä—É" style="width: 90px;display: none;" onclick="startGame();" />
            <input type="button" name="restart" value="–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É" style="width: 90px;display: none;" onclick="restart();" />
            <br>
            <input type="text" name="cell" placeholder="–í–≤–µ–¥–∏—Ç–µ —è—á–µ–π–∫—É (–ø—Ä–∏–º–µ—Ä: –ê1)" style="width:180px;display: none;" />
            <input type="button" name="hit" value="–í—ã—Å—Ç—Ä–µ–ª–∏—Ç—å" style="width: 90px; margin-left:7px;display: none;" onclick="makeHit();" />
        </form>
    </div>
    <script>
        const FIELD_SIZE = 10;

        function deepEqual([x1, y1], [x2, y2]) {
            if (x1 === x2 && y1 === y2) return true;
            return false;
        }

        function createElement(name, x, y, field) {
            console.log(field);
            const div = document.createElement('div');
            div.className = name;
            div.style.cssText = `margin-left:${(x + 1) * 40}px; margin-top:${(y + 1) * 40}px;position: fixed;`;
            document.getElementById(field).appendChild(div);
        }
        class Field {
            name;
            alphabet = ["–ê", "–ë", "–í", "–ì", "–î", "–ï", "–ñ", "–ó", "–ò", "–ö"];
            ships = [];
            field = [];
            crushedShips = 0;
            constructor(name) {
                this.name = name;
                for (let row = 0; row < FIELD_SIZE; row++) {
                    this.field[row] = [];
                    for (let col = 0; col < FIELD_SIZE; col++) {
                        this.field[row][col] = 0;
                    }
                }
            }
            generateShips() {
                let trys = 0;
                for (let i = 4; i > 0; i--) {
                    for (let j = 1; j <= 5 - i; j++) {
                        let isCorrect = true;
                        do {
                            isCorrect = true;
                            var ship = new Ship(i);
                            trys++;
                            if (trys > 500) {
                                this.ships = [];
                                this.generateShips();
                                return;
                            }
                            for (let k = 0; k < this.ships.length; k++) {
                                if (this.ships[k].isConnectTo(ship)) {
                                    isCorrect = false;
                                    break;
                                }
                            }

                            /*this.ships.forEach(function(item) {
                                console.log(item.isConnectTo(ship));
                                if (item.isConnectTo(ship)) {
                                    isCorrect = false;
                                    //break
                                }
                            });*/

                        } while (isCorrect === false);
                        this.ships.push(ship);
                        console.log("good");
                    }
                }
            }
            reset() {
                this.ships = [];
                document.getElementById(this.name).innerHTML = '';
            }
            showShips() {
                name = this.name;
                this.ships.forEach(function(item) {
                    item.show(name);
                });
            }
            hit(cell) {
                if (cell === null || cell.length > 3) {alert("–ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥ !"); return 0;}
                let col = this.alphabet.indexOf(cell.charAt(0));
                let row = Number(cell.match(/\d+/)[0]) - 1;
                if (row < 0 || row > 9 || col < 0 || col > 9) {alert("–ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥ !"); return 0;}
                if (this.field[row][col] === 1) return 0;
                this.field[row][col] = 1;
                for (let i = 0; i < this.ships.length; i++) {
                    if (this.ships[i].isHit(row, col)) {
                        createElement('cross', col, row, this.name);
                        if (this.ships[i].isAllHit()) {
                            this.crushedShips++;
                            this.ships[i].show(this.name);
                        }
                        return 2;
                    }
                }
                createElement('dot', col, row, this.name);
                return 1;
            }
            isLose() {
                if (this.crushedShips === this.ships.length) return true;
                return false;
            }
        }

        function replace(coord, value) {
            if (coord[0] < 0 || coord[0] > 9) coord[0] = value;
            if (coord[1] < 0 || coord[1] > 9) coord[1] = value;
        }
        class Ship {
            hits = 0;
            name;
            row;
            col;
            size;
            direction;
            startCoord;
            finishCoord;
            coordinate = [];
            constructor(size) {
                this.size = size;

                this.direction = Math.floor(Math.random() * 2);
                if (this.direction === 1) {
                    this.col = Math.floor(Math.random() * (FIELD_SIZE - this.size));
                    this.row = Math.floor(Math.random() * FIELD_SIZE);

                } else {
                    this.row = Math.floor(Math.random() * (FIELD_SIZE - this.size));
                    this.col = Math.floor(Math.random() * FIELD_SIZE);
                }
                for (let i = 0; i < size; i++) {
                    if (this.direction === 1) this.coordinate.push([this.row, this.col + i]);
                    else this.coordinate.push([this.row + i, this.col]);
                }
                this.startCoord = [this.row - 1, this.col - 1];
                replace(this.startCoord, 0);
                if (this.direction === 1) this.finishCoord = [this.row + 1, this.col + size];
                else this.finishCoord = [this.row + size, this.col + 1];
                replace(this.finishCoord, 9);

            }
            show(fieldName) {
                const dir = (this.direction == 1) ? '' : ' vertical';
                let name = 'ship deck' + this.size + dir;
                createElement(name, this.col, this.row, fieldName);
            }
            isHit(row, col) {
                for (let i = 0; i < this.size; i++) {
                    if (deepEqual(this.coordinate[i], [row, col])) {
                        this.hits++;
                        return true;
                    }
                }
                return false;
            }
            isAllHit() {
                if (this.hits === this.size) return true;
                return false;
            }
            isConnectTo(ship) {
                if (Math.abs(this.startCoord[0] - ship.startCoord[0]) > 1 && Math.abs(ship.finishCoord[0] - this.finishCoord[0]) > 1 || (Math.abs(this.startCoord[1] - ship.startCoord[1]) > 1 && Math.abs(ship.finishCoord[1] - this.finishCoord[1]) > 1)) {
                    if ((ship.startCoord[0] < this.finishCoord[0] && Math.abs(ship.startCoord[1] - this.startCoord[1]) < 2) || (this.startCoord[0] > ship.finishCoord[0] && Math.abs(this.startCoord[1] - ship.startCoord[1]) < 2)) return true;
                    if ((ship.startCoord[1] < this.finishCoord[1] && Math.abs(ship.startCoord[0] - this.startCoord[0]) < 2) || (this.startCoord[1] > ship.finishCoord[1] && Math.abs(this.startCoord[0] - ship.startCoord[0]) < 2)) return true;
                    return false;
                    //if((this.startCoord[0] - ship.finishCoord[0] !=0) && (this.finishCoord[1] - ship.startCoord[1] !=0))  return false;
                }
                return true;
            }
        }
        var firstPlayer = new Field("first_field");
        var secondPlayer = new Field("second_field");
        var PLAYER = 1;
        var firstClick = true;

        function chooseField() {
            document.getElementById('change').style.display = 'inline';
            if (firstClick) {
                document.getElementById('print').textContent = '–ò–≥—Ä–æ–∫ 1 –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–ª–µ...';
                search.start.style.display = 'none';
                search.success.style.display = 'inline';
                firstPlayer.generateShips();
                firstPlayer.showShips();
                firstClick = false;
            } else {
                PLAYER = 2;
                document.getElementById('print').textContent = '–ò–≥—Ä–æ–∫ 2 –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–ª–µ...';
                search.start.style.display = 'none';
                search.ready.style.display = 'inline';
                secondPlayer.generateShips();
                secondPlayer.showShips();
            }
        }

        function changeField() {
            let curField = (PLAYER === 1) ? firstPlayer : secondPlayer;
            curField.reset();
            curField.generateShips();
            curField.showShips();
        }

        function startGame() {
            document.getElementById("second_field").innerHTML = '';
            search.ready.style.display = 'none';
            document.getElementById('change').style.display = 'none';
            search.cell.style.display = 'inline';
            search.hit.style.display = 'inline';
            document.getElementById('print').textContent = '–ö–æ—Ä–∞–±–ª–∏ –ò–≥—Ä–æ–∫–∞ 2 –≤—ã–±—Ä–∞–Ω—ã! –ò–≥—Ä–æ–∫ 1 —Å—Ç—Ä–µ–ª—è–µ—Ç...';
            PLAYER = 1;
        }

        function emptyField() {
            document.getElementById("first_field").innerHTML = '';
            document.getElementById('print').textContent = '–ö–æ—Ä–∞–±–ª–∏ –ò–≥—Ä–æ–∫–∞ 1 –≤—ã–±—Ä–∞–Ω—ã!';
            document.getElementById('change').style.display = 'none';
            search.start.style.display = 'inline';
            search.success.style.display = 'none';
        }

        function restart() {
            document.getElementById("first_field").innerHTML = '';
            document.getElementById("second_field").innerHTML = '';
            search.start.style.display = 'inline';

        }

        function makeHit() {
            var text = search.cell.value.trim();
            if (PLAYER === 1) {
                if (secondPlayer.hit(text) === 1) {
                    document.getElementById('print').textContent = '–ò–≥—Ä–æ–∫ 2 —Å—Ç—Ä–µ–ª—è–µ—Ç...';
                    PLAYER = 2;
                }
                if (secondPlayer.isLose()) {
                    search.cell.style.display = 'none';
                    search.hit.style.display = 'none';
                    document.getElementById('print').textContent = '–ü–æ–±–µ–¥–∏–ª –ò–≥—Ä–æ–∫ 1 !';
                }
            } else {
                if (firstPlayer.hit(text) === 1) {
                    document.getElementById('print').textContent = '–ò–≥—Ä–æ–∫ 1 —Å—Ç—Ä–µ–ª—è–µ—Ç...';
                    PLAYER = 1;
                }
                if (firstPlayer.isLose()) {
                    search.cell.style.display = 'none';
                    search.hit.style.display = 'none';
                    document.getElementById('print').textContent = '–ü–æ–±–µ–¥–∏–ª –ò–≥—Ä–æ–∫ 2 !';
                }
            }
        }
        document.getElementById('searchf').addEventListener('submit', makeHit, false);
    </script>
</body></html>
